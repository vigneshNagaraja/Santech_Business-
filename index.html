<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Super Company Timesheet</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" href="icons/icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>body{-webkit-tap-highlight-color:transparent}</style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useEffect,useMemo} = React;
    const KEY_ENTRIES = "sc.timesheet.entries.v1";
    const KEY_SETTINGS = "sc.timesheet.settings.v1";

    const minutesBetween=(s,e)=>{
      if(!s||!e) return 0;
      const [sh,sm]=s.split(":").map(Number),[eh,em]=e.split(":").map(Number);
      return Math.max(0,(eh*60+em)-(sh*60+sm));
    };
    const toCSV=(rows)=>{
      const headers=["date","employee","team_code","project","task","start_time","end_time","minutes","notes"];
      const esc=v=>{const s=String(v??"").replace(/"/g,'""');return /[",\n]/.test(s)?`"${s}"`:s;};
      return [headers.join(",")].concat(rows.map(r=>headers.map(h=>esc(r[h])).join(","))).join("\n");
    };

    function Settings({settings,setSettings,onClose}){
      const [tmp,setTmp]=useState(settings);
      return (
        <div className="fixed inset-0 bg-black/30 backdrop-blur flex items-end sm:items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl w-full max-w-md p-4 shadow-lg">
            <h2 className="text-lg font-semibold">Settings</h2>
            <div className="mt-3 grid gap-3">
              <label className="grid gap-1 text-sm">
                <span className="font-medium">Employee name</span>
                <input className="border rounded-xl px-3 py-2" value={tmp.employee} onChange={e=>setTmp({...tmp, employee:e.target.value})} placeholder="e.g., Alex Kumar"/>
              </label>
              <label className="grid gap-1 text-sm">
                <span className="font-medium">Team code</span>
                <input className="border rounded-xl px-3 py-2" value={tmp.team_code} onChange={e=>setTmp({...tmp, team_code:e.target.value})} placeholder="e.g., SC-OPS"/>
              </label>
            </div>
            <div className="flex gap-2 mt-4">
              <button className="px-4 py-2 rounded-xl border" onClick={onClose}>Cancel</button>
              <button className="ml-auto px-4 py-2 rounded-xl bg-slate-900 text-white" onClick={()=>{setSettings(tmp);onClose();}}>Save</button>
            </div>
          </div>
        </div>
      );
    }

    function App(){
      const [entries,setEntries]=useState(()=>{try{return JSON.parse(localStorage.getItem(KEY_ENTRIES)||"[]")}catch{return []}});
      const [settings,setSettings]=useState(()=>{try{return JSON.parse(localStorage.getItem(KEY_SETTINGS)||"{\"employee\":\"\",\"team_code\":\"\"}")}catch{return {employee:"",team_code:""}}});
      const [form,setForm]=useState({date:new Date().toISOString().slice(0,10), project:"", task:"", start_time:"", end_time:"", notes:""});
      const [filterDate,setFilterDate]=useState(""),[editingId,setEditingId]=useState(null),[showSettings,setShowSettings]=useState(false);

      useEffect(()=>localStorage.setItem(KEY_ENTRIES, JSON.stringify(entries)),[entries]);
      useEffect(()=>localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)),[settings]);
      useEffect(()=>{ if("serviceWorker" in navigator){ navigator.serviceWorker.register("./service-worker.js").catch(()=>{});} },[]);

      const filtered=useMemo(()=>filterDate?entries.filter(e=>e.date===filterDate):entries,[entries,filterDate]);
      const totalMins=useMemo(()=>filtered.reduce((s,e)=>s+(e.minutes||0),0),[filtered]);

      const resetForm=()=>{setForm({date:new Date().toISOString().slice(0,10), project:"", task:"", start_time:"", end_time:"", notes:""}); setEditingId(null);};
      const handleSubmit=(e)=>{
        e.preventDefault();
        if(!form.date||!form.project||!form.start_time||!form.end_time){ alert("Please fill Date, Project, Start & End"); return; }
        if(!settings.employee){ alert("Please set your name in Settings"); return; }
        const rec={...form, minutes:minutesBetween(form.start_time, form.end_time), employee:settings.employee, team_code:settings.team_code};
        if(editingId!=null){ setEntries(entries.map((r,i)=>i===editingId?rec:r)); } else { setEntries([rec,...entries]); }
        resetForm();
      };
      const handleEdit=(i)=>{ const r=entries[i]; setForm({date:r.date, project:r.project, task:r.task, start_time:r.start_time, end_time:r.end_time, notes:r.notes||""}); setEditingId(i); window.scrollTo({top:0,behavior:"smooth"});};
      const handleDelete=(i)=>{ if(confirm("Delete this entry?")) setEntries(entries.filter((_,idx)=>idx!==i)); };
      const downloadCSV=()=>{ const csv=toCSV(entries); const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="SC_timesheet_"+new Date().toISOString().slice(0,10)+".csv"; a.click(); URL.revokeObjectURL(url); };

      return (
        <div className="min-h-screen p-4 pb-24 max-w-xl mx-auto">
          <header className="sticky top-0 bg-slate-50/90 backdrop-blur z-10 py-3 flex items-center gap-2">
            <img src="icons/icon-192.png" alt="logo" className="w-7 h-7 rounded-lg" />
            <h1 className="text-2xl font-bold">Super Company — Timesheet</h1>
            <button onClick={()=>setShowSettings(true)} className="ml-auto text-sm underline">Settings</button>
          </header>

          <form onSubmit={handleSubmit} className="mt-4 grid gap-3">
            <div className="grid grid-cols-2 gap-3">
              <label className="grid gap-1 text-sm"><span className="font-medium">Date</span>
                <input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} className="border rounded-xl px-3 py-2" />
              </label>
              <label className="grid gap-1 text-sm"><span className="font-medium">Project</span>
                <input placeholder="e.g., Alpha" value={form.project} onChange={e=>setForm({...form, project:e.target.value})} className="border rounded-xl px-3 py-2" />
              </label>
            </div>
            <label className="grid gap-1 text-sm"><span className="font-medium">Task (optional)</span>
              <input placeholder="e.g., Design review" value={form.task} onChange={e=>setForm({...form, task:e.target.value})} className="border rounded-xl px-3 py-2" />
            </label>
            <div className="grid grid-cols-2 gap-3">
              <label className="grid gap-1 text-sm"><span className="font-medium">Start</span>
                <input type="time" value={form.start_time} onChange={e=>setForm({...form, start_time:e.target.value})} className="border rounded-xl px-3 py-2" />
              </label>
              <label className="grid gap-1 text-sm"><span className="font-medium">End</span>
                <input type="time" value={form.end_time} onChange={e=>setForm({...form, end_time:e.target.value})} className="border rounded-xl px-3 py-2" />
              </label>
            </div>
            <label className="grid gap-1 text-sm"><span className="font-medium">Notes</span>
              <textarea rows="2" placeholder="Optional" value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})} className="border rounded-xl px-3 py-2" />
            </label>
            <div className="flex gap-2">
              <button type="submit" className="px-4 py-2 rounded-xl bg-slate-900 text-white font-medium">{editingId!=null?"Update Entry":"Save Entry"}</button>
              <button type="button" onClick={resetForm} className="px-4 py-2 rounded-xl border font-medium">Reset</button>
              <button type="button" onClick={downloadCSV} className="ml-auto px-4 py-2 rounded-xl border font-medium">Export CSV</button>
            </div>
          </form>

          <section className="mt-6 grid gap-2">
            <div className="flex items-end gap-2">
              <div className="text-sm font-medium">Entries</div>
              <input type="date" value={filterDate} onChange={e=>setFilterDate(e.target.value)} className="ml-auto border rounded-xl px-3 py-1 text-sm"/>
              {filterDate && <button onClick={()=>setFilterDate("")} className="text-sm underline">Clear</button>}
            </div>
            <div className="text-sm text-slate-600">Total: {(totalMins/60).toFixed(2)} hrs</div>
            {filtered.length===0 && <div className="text-sm text-slate-500 py-6 text-center">No entries yet.</div>}
            <ul className="grid gap-2">
              {filtered.map((e,i)=>(
                <li key={i} className="bg-white rounded-2xl shadow-sm border p-3">
                  <div className="flex items-center gap-2">
                    <div className="text-sm font-semibold">{e.project}</div>
                    <div className="ml-auto text-xs text-slate-500">{e.date}</div>
                  </div>
                  <div className="text-xs text-slate-500 mt-0.5">{e.employee}{e.team_code?` • ${e.team_code}`:""}</div>
                  {e.task && <div className="text-sm text-slate-700 mt-1">{e.task}</div>}
                  <div className="text-sm mt-1">{e.start_time} → {e.end_time} • {(e.minutes/60).toFixed(2)} h</div>
                  {e.notes && <div className="text-xs text-slate-500 mt-1">{e.notes}</div>}
                  <div className="flex gap-3 mt-2">
                    <button onClick={()=>handleEdit(i)} className="text-sm underline">Edit</button>
                    <button onClick={()=>handleDelete(i)} className="text-sm underline text-red-600">Delete</button>
                  </div>
                </li>
              ))}
            </ul>
          </section>

          {showSettings && <Settings settings={settings} setSettings={setSettings} onClose={()=>setShowSettings(false)} />}
          <footer className="h-10" />
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
